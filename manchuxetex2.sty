\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{manchuxetex2}
  [2015/10/06 v0.1 ArabXeTeX-like interface for Manchu]
%
\DeclareOption{trans}{\def\mx@mode{trans}}
\DeclareOption{utf}{\def\mx@mode{utf}}
\DeclareOption*{%
\PackageWarning{manchuxetex}{Unknown option `\CurrentOption'}%
}
\ExecuteOptions{utf}
\ProcessOptions
\def\mx@mode@trans{trans}
\def\mx@mode@utf{utf}
\newif\ifmx@mode@defined
\def\mx@ismode@defined#1{%
	\ifcsname mx@mode@#1\endcsname%
		\mx@mode@definedtrue%
	\else
		\mx@mode@definedfalse%
	\fi}
\def\mx@lang{manchu}
\RequirePackage{fontspec}
\AtBeginDocument{\ifdefined\manchufont\relax\else
	\PackageWarning{manchuxetex}{`\string\manchufont' is not defined!^^JI will try to load Mongolian Baiti}%
	\newfontfamily\manchufont[Script=mong,Language=MCH ,]{Mongolian Baiti}\fi}%
\def\mx@trans@style{\itshape}%
\newcommand{\SetTranslitStyle}[1]{\def\mx@trans@style{#1}}
\newcommand{\SetTranslitConvention}[1]{\def\mx@trans@convention{#1}}
\def\mx@trans@convention{mdf}% MÃ¶llendorf is default

\newenvironment{manchu}[1][\mx@modes]%
{\edef\@tempa{#1}%
\def\mx@lang{manchu}%
\mx@ismode@defined{\@tempa}%
\ifmx@mode@defined%
	\ifx\@tempa\mx@mode@trans%
		\par\mx@trans@style%
		\addfontfeature{Mapping=manchuxetex-trans-\mx@trans@convention}%
	\else
		\par\manchufont%
		\addfontfeature{Mapping=manchuxetex-\@tempa}%
	\fi
\else
	\PackageWarning{manchuxetex}{Mode \@tempa\ not defined, defaulting to \@mx@mode}%
	\par\manchufont%
	\addfontfeature{Mapping=manchuxetex-\mx@mode}%
\fi}
{}
%%%
\newsavebox{\verticalmanchubox}
\newenvironment{vmanchu}[1][]%
	{
		\begin{lrbox}{\verticalmanchubox}%
			\XeTeXupwardsmode1%
			\begin{minipage}{#1}%
				\raggedright%
				\par\manchufont%
				\addfontfeature{Mapping=manchuxetex-\mx@mode}%
	}%
	{
		\end{minipage}%
		\XeTeXupwardsmode0
		\end{lrbox}{
			\rotatebox{-90}{
				\usebox{\verticalmanchubox}%
			}%
		}%
	}%
%%%
\newcommand\textmanchu{\bgroup\text@manchu}
\let\textmnc\textmanchu
\newcommand\text@manchu[2][\mx@mode]{%
	\edef\@tempa{#1}%
	\def\mx@lang{manchu}%
	\mx@ismode@defined{\@tempa}%
	\ifmx@mode@defined%
		\ifx\@tempa\mx@mode@trans%
			{\mx@trans@style\addfontfeature{Mapping=manchuxetex-trans-\mx@trans@convention}\scantokens{#2\noexpand}}%
		\else
		\ifx\@tempa%
			{\manchufont #2}%
		\else
			{\manchufont\addfontfeature{Mapping=manchuxetex-\@tempa}\scantokens{#2\noexpand}}%
		\fi\fi
	\else
	\PackageWarning{manchuxetex}{Mode `\@tempa' not defined, defaulting to `\mx@mode'}%
	{\manchufont\addfontfeature{Mapping=manchuxetex-\mx@mode}\scantokens{#2\noexpand}}%
	\fi\egroup}