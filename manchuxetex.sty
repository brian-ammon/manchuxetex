\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{manchuxetex}
  [2015/10/06 v0.4 ArabXeTeX-like interface for Manchu]
%
\DeclareOption{manchu}{\def\mx@mode{manchu}}
\DeclareOption{trans}{\def\mx@mode{trans}}
\DeclareOption{utf}{\def\mx@mode{utf}}
\DeclareOption*{%
	\PackageWarning{manchuxetex}{Unknown option `\CurrentOption'}%
}
\ExecuteOptions{manchu}
\ProcessOptions
\def\mx@mode@manchu{manchu}
\def\mx@mode@trans{trans}
\def\mx@mode@utf{utf}
\newif\ifmx@mode@defined
\def\mx@ismode@defined#1{%
	\ifcsname mx@mode@#1\endcsname%
		\mx@mode@definedtrue%
	\else
		\mx@mode@definedfalse%
	\fi}
\def\mx@lang{manchu}
\RequirePackage{fontspec}
\AtBeginDocument{\ifdefined\manchufont\relax\else
	\PackageWarning{manchuxetex}{`\string\manchufont' is not defined!^^JI will try to load Mongolian Baiti}%
	\newfontfamily\manchufont[Script=mong,Language=MCH ,Scale=MatchUppercase]{Mongolian Baiti}\fi}%
\def\mx@trans@style{\itshape}%
\newcommand{\SetTranslitStyle}[1]{\def\mx@trans@style{#1}}
\newcommand{\SetTranslitConvention}[1]{\def\mx@trans@convention{#1}}
\def\mx@trans@convention{mdf}% MÃ¶llendorf is default
\def\utf@fontfeature{\addfontfeature{Script=mong,Language=MCH ,}}

\newenvironment{manchu}[1][\mx@mode]%
{\edef\@tempa{#1}%
\def\mx@lang{manchu}%
\mx@ismode@defined{\@tempa}%
\ifmx@mode@defined%
	\ifx\@tempa\mx@mode@trans%
		\par\mx@trans@style%
		\addfontfeature{Mapping=manchuxetex-trans-\mx@trans@convention}%
	\else
	\ifx\@tempa\mx@mode@utf%
		\par\manchufont\utf@fontfeature%
	\else
		\par\manchufont%
		\addfontfeature{Mapping=manchuxetex-\@tempa}%
	\fi\fi
\else
	\PackageWarning{manchuxetex}{Mode `\@tempa' not defined, defaulting to `\mx@mode'}%
	\par\manchufont%
	\addfontfeature{Mapping=manchuxetex-\mx@mode}%
\fi}
{\ifx\@tempa\mx@mode@trans\relax\else\relax\fi\par}% What does this do?
%%%
\newsavebox{\verticalmanchubox}
\newenvironment{vmanchu}[2][\mx@mode]%
	{% Before
		\begin{lrbox}{\verticalmanchubox}% Content saved in a box because of the rotatebox
			\XeTeXupwardsmode1% successive lines will be stacked upwards instead of downwards
			\begin{minipage}{#2}%
				\raggedright% a stylistic choice, after all
				\begin{manchu}[#1]
%				\par\manchufont% Font selection
%				\addfontfeature{Mapping=manchuxetex-\mx@mode}%
	}% End "before"
	{% After
		\end{manchu}
		\end{minipage}%
		\XeTeXupwardsmode0
		\end{lrbox}{
			\rotatebox{-90}{
				\usebox{\verticalmanchubox}%
			}% End "\rotatebox"
		}% End "\end{lrbox}"
	}% End "after"
%%%
\newcommand\textmanchu{\bgroup\text@manchu}
\let\textmnc\textmanchu
\newcommand\text@manchu[2][\mx@mode]{%
	\edef\@tempa{#1}%
	\def\mx@lang{manchu}%
	\mx@ismode@defined{\@tempa}%
	\ifmx@mode@defined%
		\ifx\@tempa\mx@mode@trans%
			{\mx@trans@style\addfontfeature{Mapping=manchuxetex-trans-\mx@trans@convention}\scantokens{#2\noexpand}}%
		\else
		\ifx\@tempa%
			{\manchufont #2}%
		\else
			{\manchufont\addfontfeature{Mapping=manchuxetex-\@tempa}\scantokens{#2\noexpand}}%
		\fi\fi
	\else
	\PackageWarning{manchuxetex}{Mode `\@tempa' not defined, defaulting to `\mx@mode'}%
	{\manchufont\addfontfeature{Mapping=manchuxetex-\mx@mode}\scantokens{#2\noexpand}}%
	\fi\egroup}